<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            color-scheme: light;
        }
        body {
            background: #f8fafc;
            color: #0f172a;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .shell-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 12px 36px rgba(15, 23, 42, 0.08);
            backdrop-filter: blur(10px);
        }
        .badge-soft {
            background: #eef2ff;
            color: #4338ca;
            border: 1px solid #e0e7ff;
        }
        .tab {
            color: #334155;
            border: 1px solid #e5e7eb;
            background: #ffffff;
        }
        .tab.tab-active {
            background: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
        }
        .stat-pill {
            border: 1px solid #e5e7eb;
            background: #ffffff;
            border-radius: 9999px;
            padding: 0.35rem 0.65rem;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: #1f2937;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
        }
        .sticky-tabs {
            position: sticky;
            top: 0;
            z-index: 20;
            padding-top: 0.5rem;
            background: linear-gradient(180deg, #f8fafc 70%, rgba(248, 250, 252, 0.6));
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="h-11 w-11 rounded-2xl bg-gradient-to-br from-blue-500 via-purple-500 to-emerald-400 grid place-items-center text-white font-bold">AI</div>
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Dashboard Generator</p>
                    <h1 class="text-xl font-semibold text-slate-900 flex items-center gap-2">
                        Dataset Insights
                        {% if original_filename %}
                            {% set name_parts = original_filename.split('.') %}
                            {% set name_without_ext = name_parts[0] if name_parts|length > 0 else original_filename %}
                            {% set formatted_name = name_without_ext|replace('_', ' ')|replace('-', ' ')|title %}
                            <span class="badge badge-outline">{{ formatted_name }}</span>
                        {% endif %}
                    </h1>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-2 md:justify-end text-sm">
                {% if dataset_profile.role_counts %}
                    <span class="stat-pill">Rows {{ dataset_profile.n_rows }}</span>
                    <span class="stat-pill">Cols {{ dataset_profile.n_cols }}</span>
                    <span class="stat-pill">Numeric {{ dataset_profile.role_counts.numeric }}</span>
                    <span class="stat-pill">Categorical {{ dataset_profile.role_counts.categorical }}</span>
                    <span class="stat-pill">Datetime {{ dataset_profile.role_counts.datetime }}</span>
                {% else %}
                    <span class="stat-pill">Rows {{ dataset_profile.n_rows }}</span>
                    <span class="stat-pill">Cols {{ dataset_profile.n_cols }}</span>
                {% endif %}
                <a href="/" class="btn btn-ghost btn-xs border border-slate-200 text-slate-700">Back</a>
                <a href="/" class="btn btn-primary btn-xs">Upload</a>
            </div>
        </header>

        <div class="shell-card rounded-3xl p-5 mb-5">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div class="space-y-2">
                    <p class="text-xs uppercase tracking-[0.25em] text-slate-500">Auto-generated overview</p>
                    <h2 class="text-3xl font-bold text-slate-900">Dashboard for your data</h2>
                    <p class="text-slate-600 text-sm md:text-base max-w-3xl">We inferred column roles, generated KPIs, surfaced EDA patterns, and curated visualizations so you can explore instantly.</p>
                </div>
                <div class="flex flex-wrap gap-2 text-sm items-center">
                    <span class="badge badge-soft">Always-on analysis</span>
                    <span class="badge badge-soft">Charts ready</span>
                </div>
            </div>
        </div>

        <div class="sticky-tabs mb-5">
            <div class="tabs tabs-boxed bg-transparent">
                <button class="tab tab-active" onclick="showSection('overview', event)">Overview</button>
                <button class="tab" onclick="showSection('eda', event)">EDA Insights</button>
                <button class="tab" onclick="showSection('visualizations', event)">Data Viz</button>
                <button class="tab" onclick="showSection('column_profiling', event)">Column Profiling</button>
            </div>
        </div>

        <div class="space-y-6">
            <!-- Overview Section -->
            <section id="overview-section" class="analysis-section">
                <div class="shell-card rounded-3xl p-5 mb-4">
                    <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                        <div>
                            <p class="text-xs uppercase tracking-[0.25em] text-slate-500 mb-2">KPIs</p>
                            <div class="flex flex-wrap gap-2">
                                {% if kpis and kpis|length > 0 %}
                                    {% for kpi in kpis %}
                                        {% set chart_obj = category_charts.get(kpi.label) %}
                                        <div
                                            class="badge badge-outline px-3 py-2 text-xs {% if chart_obj %}cursor-pointer hover:border-primary hover:text-primary{% else %}opacity-70{% endif %}"
                                            data-kpi-column="{{ kpi.label }}"
                                            data-has-chart="{{ '1' if chart_obj else '0' }}"
                                            title="{% if chart_obj %}Click to highlight the related chart{% else %}No chart available yet for this KPI{% endif %}"
                                        >
                                            <strong>{{ kpi.label }}</strong>: {{ kpi.value }}
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-slate-500">No KPIs generated yet.</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-sm text-slate-600 lg:text-right">
                            <p class="font-semibold text-slate-900">Quick summary</p>
                            <p>We prioritized distributions and metrics to keep the context of your dataset visible.</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    {% if primary_chart %}
                        <div class="lg:col-span-2 shell-card rounded-3xl p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-semibold text-slate-900">{{ primary_chart.title or primary_chart.column|title }}</h3>
                                <span class="badge badge-soft">Featured</span>
                            </div>
                            <div class="chart-container h-96" id="chart-{{ primary_chart.column|replace(' ', '_')|replace('.', '_') }}"></div>
                        </div>
                    {% endif %}

                    <div class="shell-card rounded-3xl p-5 space-y-4">
                        <div class="flex items-center justify-between">
                            <p class="text-sm text-slate-600">Dataset summary</p>
                            <span class="badge badge-soft">Schema</span>
                        </div>
                        <div class="space-y-2 text-sm text-slate-700">
                            <div class="flex justify-between"><span>Rows</span><span class="font-semibold text-slate-900">{{ dataset_profile.n_rows }}</span></div>
                            <div class="flex justify-between"><span>Columns</span><span class="font-semibold text-slate-900">{{ dataset_profile.n_cols }}</span></div>
                            {% if dataset_profile.role_counts %}
                                <div class="flex justify-between"><span>Datetime</span><span class="font-semibold text-slate-900">{{ dataset_profile.role_counts.datetime }}</span></div>
                                <div class="flex justify-between"><span>Text</span><span class="font-semibold text-slate-900">{{ dataset_profile.role_counts.text }}</span></div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mt-6">
                    {% if category_charts and category_charts|length > 0 %}
                        {% for col_name, chart_data in category_charts.items() %}
                            {% if not primary_chart or chart_data.column != primary_chart.column %}
                                <div class="shell-card rounded-2xl p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-semibold text-slate-900">{{ chart_data.title or col_name|title + " Distribution" }}</h4>
                                        <span class="badge badge-soft">Category</span>
                                    </div>
                                    <div class="chart-container h-80" id="chart-{{ col_name|replace(' ', '_')|replace('.', '_') }}"></div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_charts and all_charts|length > 0 %}
                        {% for chart in all_charts %}
                            {% if chart is defined and chart.data is defined %}
                                <div class="shell-card rounded-2xl p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-semibold text-slate-900">{{ chart.title or chart.type|title + " Chart" }}</h4>
                                        <span class="badge badge-soft">{{ chart.type|title }}</span>
                                    </div>
                                    <div class="chart-container h-80" id="chart_{{ loop.index }}"></div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>

                {% if (not category_charts or category_charts|length == 0) and (not all_charts or all_charts|length == 0) %}
                    <div class="alert alert-warning shell-card mt-6">
                        <div class="flex-1 text-slate-700">No charts available for this dataset yet.</div>
                    </div>
                {% endif %}
            </section>

            <!-- EDA Insights Section -->
            <section id="eda-section" class="analysis-section hidden">
                <div class="shell-card rounded-3xl p-6 space-y-5">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-semibold text-slate-900">Exploratory Insights</h2>
                        <span class="badge badge-soft">Auto-generated</span>
                    </div>

                    {% if eda_summary %}
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="shell-card rounded-2xl p-4">
                                <h3 class="text-lg font-semibold text-slate-900 mb-3">Key Indicators</h3>
                                {% if eda_summary.key_indicators %}
                                    <div class="space-y-2">
                                        {% for indicator in eda_summary.key_indicators[:10] %}
                                            <div class="flex items-center justify-between text-sm bg-slate-50 rounded-xl px-3 py-2">
                                                <div>
                                                    <p class="font-semibold text-slate-900">{{ indicator.indicator }}</p>
                                                    <p class="text-xs text-slate-500">{{ indicator.indicator_type }}</p>
                                                </div>
                                                <span class="badge badge-soft">{{ "%.2f"|format(indicator.significance_score) }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-slate-500 text-sm">No key indicators identified.</p>
                                {% endif %}
                            </div>

                            <div class="shell-card rounded-2xl p-4 space-y-3">
                                <h3 class="text-lg font-semibold text-slate-900">Potential Use Cases</h3>
                                {% if eda_summary.use_cases %}
                                    {% for use_case in eda_summary.use_cases %}
                                        <div class="bg-slate-50 rounded-xl p-3 text-sm">
                                            <p class="font-semibold text-slate-900">{{ use_case.use_case }}</p>
                                            <p class="text-slate-600">{{ use_case.description }}</p>
                                            <p class="text-xs text-slate-500 mt-1">Inputs: {{ use_case.key_inputs|join(', ') }}</p>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-slate-500 text-sm">No specific use cases detected.</p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="shell-card rounded-2xl p-4">
                            <h3 class="text-lg font-semibold text-slate-900 mb-3">Patterns & Relationships</h3>
                            {% if eda_summary.patterns_and_relationships %}
                                <div class="grid md:grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <p class="text-slate-500 uppercase text-xs tracking-[0.25em] mb-2">Correlations</p>
                                        {% if eda_summary.patterns_and_relationships.correlations %}
                                            <ul class="space-y-2">
                                                {% for corr in eda_summary.patterns_and_relationships.correlations[:5] %}
                                                    <li class="bg-slate-50 rounded-xl px-3 py-2">
                                                        <strong>{{ corr.variable1 }}</strong> ↔ <strong>{{ corr.variable2 }}</strong>: {{ "%.3f"|format(corr.correlation) }} ({{ corr.strength }} {{ corr.type }})
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-slate-500">No correlations found.</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <p class="text-slate-500 uppercase text-xs tracking-[0.25em] mb-2">Trends</p>
                                        {% if eda_summary.patterns_and_relationships.trends %}
                                            <ul class="space-y-2">
                                                {% for trend in eda_summary.patterns_and_relationships.trends[:5] %}
                                                    <li class="bg-slate-50 rounded-xl px-3 py-2">
                                                        <strong>{{ trend.datetime_column }}</strong> → <strong>{{ trend.numeric_column }}</strong>: {{ trend.trend_type }} ({{ "%.3f"|format(trend.trend_correlation) }})
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-slate-500">No trends detected.</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <p class="text-slate-500 uppercase text-xs tracking-[0.25em] mb-2">Outliers</p>
                                        {% if eda_summary.patterns_and_relationships.outliers %}
                                            <ul class="space-y-2">
                                                {% for outlier in eda_summary.patterns_and_relationships.outliers[:5] %}
                                                    <li class="bg-slate-50 rounded-xl px-3 py-2">
                                                        <strong>{{ outlier.column }}</strong>: {{ outlier.outlier_count }} outliers ({{ "%.2f"|format(outlier.outlier_percentage) }}%)
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-slate-500">No outliers flagged.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <p class="text-slate-500">No patterns identified.</p>
                            {% endif %}
                        </div>

                        <div class="shell-card rounded-2xl p-4">
                            <h3 class="text-lg font-semibold text-slate-900 mb-3">Recommendations</h3>
                            {% if eda_summary.recommendations %}
                                <div class="grid md:grid-cols-2 gap-3">
                                    {% for rec in eda_summary.recommendations %}
                                        <div class="bg-amber-50 border border-amber-100 rounded-xl p-3 text-sm">
                                            <p class="font-semibold text-amber-900">{{ rec.title }}</p>
                                            <p class="text-amber-700">{{ rec.description }}</p>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-slate-500">No specific recommendations at this time.</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-slate-500">No EDA insights available.</p>
                    {% endif %}
                </div>
            </section>

            <!-- Visualizations Section -->
            <section id="visualizations-section" class="analysis-section hidden">
                <div class="shell-card rounded-3xl p-6 space-y-5">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-semibold text-slate-900">Advanced Visualizations</h2>
                        <span class="badge badge-soft">Data Viz</span>
                    </div>

                    <div id="viz-container" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                    <p class="text-xs text-slate-500">These charts are generated from correlations, trends, and outlier detections.</p>
                </div>
            </section>

            <!-- Column Profiling Section -->
            <section id="column_profiling-section" class="analysis-section hidden">
                <div class="shell-card rounded-3xl p-6 space-y-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-slate-900">Column Profiling</h2>
                        <span class="badge badge-soft">Schema</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra text-sm">
                            <thead class="text-slate-600">
                                <tr>
                                    <th>Column Name</th>
                                    <th>Data Type</th>
                                    <th>Missing Values</th>
                                    <th>Unique Values</th>
                                    <th>Role</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Mean</th>
                                    <th>Top Categories</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for col in dataset_profile.columns %}
                                    <tr>
                                        <td>{{ col.name }}</td>
                                        <td>{{ col.dtype }}</td>
                                        <td>{{ col.missing_count }}</td>
                                        <td>{{ col.unique_count }}</td>
                                        <td>{{ col.role }}</td>
                                        <td>
                                            {% if col.stats and col.stats.min is not none %}
                                                {{ col.stats.min }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if col.stats and col.stats.max is not none %}
                                                {{ col.stats.max }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if col.stats and col.stats.mean is not none %}
                                                {{ col.stats.mean }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if col.top_categories and col.top_categories|length > 0 %}
                                                {% for cat in col.top_categories %}
                                                    {{ cat.value }} ({{ cat.count }}){% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

<script>
    const CATEGORY_CHARTS = {{ category_charts | tojson | safe }};
    const PRIMARY_CHART = {% if primary_chart %}{{ primary_chart | tojson | safe }}{% else %}null{% endif %};
    const ALL_CHARTS = {{ all_charts | tojson | safe }};
    const EDA_SUMMARY = {{ eda_summary | tojson | safe }};
    const PRIMARY_CHART_COLUMN = PRIMARY_CHART ? PRIMARY_CHART.column : null;

    function showSection(sectionName, evt) {
        document.querySelectorAll('.analysis-section').forEach(section => {
            section.classList.add('hidden');
            section.classList.remove('active');
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('tab-active');
        });

        const sectionElement = document.getElementById(sectionName + '-section');
        if (sectionElement) {
            sectionElement.classList.remove('hidden');
            sectionElement.classList.add('active');
        }

        const trigger = evt ? evt.currentTarget : null;
        if (trigger) {
            trigger.classList.add('tab-active');
        }

        if (sectionName === 'visualizations' && EDA_SUMMARY) {
            setTimeout(renderAdvancedVisualizations, 100);
        }
    }

    function loadChartForColumn(columnName) {
        const chart = CATEGORY_CHARTS[columnName];
        if (!chart) {
            return;
        }

        const containerId = "chart-" + columnName.replace(/[\s.]/g, '_');
        const chartContainer = document.getElementById(containerId);
        if (chartContainer) {
            chartContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            chartContainer.style.border = '2px solid #2563eb';
            setTimeout(() => {
                chartContainer.style.border = '';
            }, 1000);
        }
    }

    function renderPlotlyChart(targetId, chartObj) {
        if (!chartObj) return;
        const { data, layout } = chartObj;
        if (!data) return;
        const layoutWithTheme = {
            ...layout,
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#0f172a', family: 'Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif' }
        };
        Plotly.newPlot(targetId, data, layoutWithTheme, {responsive: true});
    }

    function renderCategoryCharts() {
        if (!CATEGORY_CHARTS) return;
        Object.entries(CATEGORY_CHARTS).forEach(([colName, chartObj]) => {
            const targetId = `chart-${colName.replace(/[\s.]/g, '_')}`;
            renderPlotlyChart(targetId, chartObj);
        });
    }

    function renderAllCharts() {
        if (!ALL_CHARTS) return;
        ALL_CHARTS.forEach((chartObj, index) => {
            if (!chartObj || !chartObj.data) return;
            const targetId = `chart_${index + 1}`;
            renderPlotlyChart(targetId, chartObj);
        });
    }

    function renderPrimaryChart() {
        if (!PRIMARY_CHART_COLUMN) return;
        const targetId = `chart-${PRIMARY_CHART_COLUMN.replace(/[\s.]/g, '_')}`;
        renderPlotlyChart(targetId, PRIMARY_CHART);
    }

    function renderAdvancedVisualizations() {
        const container = document.getElementById('viz-container');
        if (!container || !EDA_SUMMARY || !EDA_SUMMARY.patterns_and_relationships) return;

        container.innerHTML = '';
        const { correlations, trends, outliers } = EDA_SUMMARY.patterns_and_relationships;

        if (correlations) {
            correlations.slice(0, 6).forEach((corr, idx) => {
                const div = document.createElement('div');
                div.className = 'shell-card rounded-2xl p-4';
                const chartId = `corr_chart_${idx}`;
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-md font-semibold text-slate-900">Correlation</h4>
                        <span class="badge badge-soft">${corr.strength}</span>
                    </div>
                    <div id="${chartId}" class="h-64"></div>
                `;
                container.appendChild(div);

                const trace = {
                    type: 'scatter',
                    mode: 'markers',
                    x: [corr.variable1],
                    y: [corr.variable2],
                    marker: { size: Math.abs(corr.correlation) * 30 + 10, color: '#2563eb', opacity: 0.85 },
                    text: [`${corr.type}: ${corr.correlation.toFixed(3)}`]
                };
                const layout = {
                    title: `${corr.variable1} vs ${corr.variable2}`,
                    xaxis: { title: corr.variable1 },
                    yaxis: { title: corr.variable2 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };
                Plotly.newPlot(chartId, [trace], layout, {responsive: true});
            });
        }

        if (trends) {
            trends.slice(0, 6).forEach((trend, idx) => {
                const div = document.createElement('div');
                div.className = 'shell-card rounded-2xl p-4';
                const chartId = `trend_chart_${idx}`;
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-md font-semibold text-slate-900">Trend</h4>
                        <span class="badge badge-soft">${trend.trend_type}</span>
                    </div>
                    <div id="${chartId}" class="h-64"></div>
                `;
                container.appendChild(div);

                const trace = {
                    type: 'scatter',
                    mode: 'lines+markers',
                    x: trend.datetime_values || [],
                    y: trend.numeric_values || [],
                    line: { color: '#7c3aed' },
                    marker: { color: '#a855f7' },
                    name: `${trend.numeric_column}`
                };
                const layout = {
                    title: `${trend.datetime_column} → ${trend.numeric_column}`,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };
                Plotly.newPlot(chartId, [trace], layout, {responsive: true});
            });
        }

        if (outliers) {
            outliers.slice(0, 6).forEach((outlier, idx) => {
                const div = document.createElement('div');
                div.className = 'shell-card rounded-2xl p-4';
                const chartId = `outlier_chart_${idx}`;
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-md font-semibold text-slate-900">Outliers</h4>
                        <span class="badge badge-soft">${outlier.outlier_count} flagged</span>
                    </div>
                    <div id="${chartId}" class="h-64"></div>
                `;
                container.appendChild(div);

                const trace = {
                    type: 'bar',
                    x: [outlier.column],
                    y: [outlier.outlier_count],
                    marker: { color: '#f97316' }
                };
                const layout = {
                    title: `${outlier.column} (${outlier.outlier_percentage.toFixed(2)}%)`,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };
                Plotly.newPlot(chartId, [trace], layout, {responsive: true});
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderPrimaryChart();
        renderCategoryCharts();
        renderAllCharts();

        document.querySelectorAll('[data-kpi-column]').forEach(el => {
            el.addEventListener('click', () => {
                const colName = el.getAttribute('data-kpi-column');
                const hasChart = el.getAttribute('data-has-chart') === '1';
                if (hasChart) {
                    loadChartForColumn(colName);
                }
            });
        });
    });
</script>
</body>
</html>
