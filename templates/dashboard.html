<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            background: radial-gradient(circle at 20% 20%, rgba(147, 197, 253, 0.05), transparent 25%),
                        radial-gradient(circle at 80% 0%, rgba(167, 139, 250, 0.05), transparent 30%),
                        radial-gradient(circle at 40% 80%, rgba(74, 222, 128, 0.03), transparent 30%),
                        #f9fafb; /* Light background */
            color: #1f2937; /* Dark text */
        }
        .light-card {
            background-color: #ffffff; /* White background */
            border: 1px solid #e5e7eb; /* Light border */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* Subtle shadow */
        }
        .badge-soft {
            background-color: #e5e7eb; /* Light gray badge */
            color: #4b5563; /* Darker gray text */
        }
        .tab {
            color: #6b7280; /* Lighter text for inactive tab */
            border-bottom: 2px solid transparent;
        }
        .tab-active {
            color: #1f2937; /* Darker text for active tab */
            border-bottom: 2px solid #3b82f6; /* Blue indicator */
        }
        .chart-container {
            min-height: 200px; /* Minimum height for visibility */
            height: 100%; /* Take available space */
            width: 100%; /* Ensure full width */
        }
        .kpi-badge {
            transition: background-color 0.2s, color 0.2s;
        }
        .kpi-badge:hover {
            background-color: #dbeafe; /* Light blue on hover */
            color: #1d4ed8; /* Darker blue text on hover */
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-3">
                <div class="h-16 w-16 rounded-2xl bg-gradient-to-br from-blue-500 via-purple-500 to-emerald-400 grid place-items-center text-white text-2xl font-bold">AI</div>
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-gray-500">Dashboard Generator</p>
                    <h1 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        Dataset Insights
                        {% if original_filename %}
                            {% set name_parts = original_filename.split('.') %}
                            {% set name_without_ext = name_parts[0] if name_parts|length > 0 else original_filename %}
                            {% set formatted_name = name_without_ext|replace('_', ' ')|replace('-', ' ')|title %}
                            <span class="text-sm font-normal text-gray-500">- {{ formatted_name }}</span>
                        {% endif %}
                    </h1>
                </div>
            </div>
            <div>
                <button class="btn btn-sm btn-outline text-gray-700 border-gray-300">Export</button>
            </div>
        </header>

        <div class="mb-6">
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <!-- Smaller, side-by-side stats cards -->
                <div class="flex gap-2">
                    <div class="light-card rounded-xl p-3 min-w-[100px] text-center">
                        <p class="text-xs text-gray-500">Rows</p>
                        <p class="text-xl font-semibold text-gray-900">{{ dataset_profile.n_rows }}</p>
                    </div>
                    <div class="light-card rounded-xl p-3 min-w-[100px] text-center">
                        <p class="text-xs text-gray-500">Columns</p>
                        <p class="text-xl font-semibold text-gray-900">{{ dataset_profile.n_cols }}</p>
                    </div>
                    <div class="light-card rounded-xl p-3 min-w-[100px] text-center">
                        <p class="text-xs text-gray-500">Numeric</p>
                        <p class="text-xl font-semibold text-gray-900">{{ dataset_profile.role_counts.numeric if dataset_profile.role_counts else 0 }}</p>
                    </div>
                    <div class="light-card rounded-xl p-3 min-w-[100px] text-center">
                        <p class="text-xs text-gray-500">Categorical</p>
                        <p class="text-xl font-semibold text-gray-900">{{ dataset_profile.role_counts.categorical if dataset_profile.role_counts else 0 }}</p>
                    </div>
                </div>

                <!-- Financial aggregates if available -->
                {% if critical_aggregates %}
                    <div class="flex gap-2 mt-2 md:mt-0">
                        {% if critical_aggregates.total_revenue %}
                            <div class="light-card rounded-xl p-3 min-w-[120px] text-center bg-blue-50 border border-blue-200">
                                <p class="text-xs text-blue-600">Total Revenue</p>
                                <p class="text-lg font-semibold text-blue-800">${{ "%.2f"|format(critical_aggregates.total_revenue) }}</p>
                            </div>
                        {% endif %}
                        {% if critical_aggregates.total_sales %}
                            <div class="light-card rounded-xl p-3 min-w-[120px] text-center bg-green-50 border border-green-200">
                                <p class="text-xs text-green-600">Total Sales</p>
                                <p class="text-lg font-semibold text-green-800">${{ "%.2f"|format(critical_aggregates.total_sales) }}</p>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Critical Financial Totals Section -->
        {% if critical_totals and critical_totals|length > 0 %}
        <div class="light-card rounded-3xl p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-gray-900">Financial & Quantity Totals</h2>
                <span class="badge badge-soft">Pre-sampling</span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {% for key, value in critical_totals.items() %}
                    <div class="light-card rounded-2xl p-4 text-center">
                        <p class="text-sm text-gray-600">{{ key }}</p>
                        {% if 'amount' in key.lower() or 'revenue' in key.lower() or 'cost' in key.lower() or 'expense' in key.lower() or 'profit' in key.lower() or 'fee' in key.lower() or 'charge' in key.lower() or 'payment' in key.lower() or 'income' in key.lower() or 'value' in key.lower() %}
                            <p class="text-xl font-bold text-green-600">${{ "%.2f"|format(value) }}</p>
                        {% else %}
                            <p class="text-xl font-bold text-blue-600">{{ value|round(2) }}</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Visible Tabs -->
        <div class="tabs tabs-boxed bg-gray-100 mb-6">
            <button class="tab tab-active" onclick="showSection('overview', event)">Overview</button>
            <button class="tab" onclick="showSection('eda', event)">EDA Insights</button>
            <button class="tab" onclick="showSection('visualizations', event)">Visual Gallery</button>
            <button class="tab" onclick="showSection('column_profiling', event)">Columns</button>
        </div>
        </div>

        <div class="space-y-6">
            <!-- Overview Section -->
            <section id="overview-section" class="analysis-section">
                <div class="light-card rounded-3xl p-6 mb-6">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div>
                            <p class="text-xs uppercase tracking-[0.25em] text-gray-500 mb-2">KPIs</p>
                            <div class="flex flex-wrap gap-2">
                                {% if kpis and kpis|length > 0 %}
                                    {% for kpi in kpis %}
                                        <div class="badge badge-soft kpi-badge text-gray-700 bg-gray-100 border border-gray-200"
                                             data-kpi-column="{{ kpi.label }}"
                                             data-has-chart="{% if kpi.label in category_charts %}1{% else %}0{% endif %}">
                                            <span class="font-semibold">{{ kpi.label|title }}:</span> {{ kpi.value }}
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-gray-500 text-sm">No KPIs generated.</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-right text-sm text-gray-600">
                            <p class="font-semibold text-gray-900">Quick summary</p>
                            <p>We prioritized key distributions and metrics to provide clear insights.</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    {% if primary_chart %}
                        <div class="lg:col-span-2 light-card rounded-3xl p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-semibold text-gray-900">{{ primary_chart.get('title', primary_chart.get('column', 'Primary Chart')|title) }}</h3>
                                <span class="badge badge-soft">Featured</span>
                            </div>
                            <div class="chart-container h-80" id="primary-chart"></div>
                        </div>
                    {% endif %}

                    <div class="lg:col-span-1 space-y-4">
                        {% if category_charts %}
                            {% for column, chart_data in category_charts.items() %}
                                <div class="light-card rounded-2xl p-4">
                                    <h4 class="text-md font-semibold text-gray-900 mb-2">{{ chart_data.get('title', column|title) }}</h4>
                                    <div class="chart-container h-48" id="chart-{{ column|replace(' ', '_')|replace('.', '_') }}"></div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="light-card rounded-2xl p-4 text-center text-gray-500 italic">
                                No categorical charts generated.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="light-card rounded-3xl p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-gray-900">All Generated Charts</h2>
                        <span class="badge badge-soft">Gallery</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        {% if all_charts %}
                            {% for chart in all_charts %}
                                <div class="light-card rounded-2xl p-4">
                                    <h4 class="text-md font-semibold text-gray-900 mb-2">{{ chart.get('title', chart.get('id', 'Chart')|title) }}</h4>
                                    <div class="chart-container h-64" id="chart-{{ chart.id }}"></div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-span-full light-card rounded-2xl p-4 text-center text-gray-500 italic">
                                No additional charts generated.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- EDA Insights Section -->
            <section id="eda-section" class="analysis-section hidden">
                <div class="light-card rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-gray-900">EDA Insights</h2>
                        <span class="badge badge-soft">Analysis</span>
                    </div>
                    {% if eda_summary %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h3 class="text-xl font-semibold text-gray-900">Key Indicators</h3>
                                {% if eda_summary.key_indicators %}
                                    <ul class="list-disc pl-5 space-y-1 text-gray-700">
                                        {% for indicator in eda_summary.key_indicators[:5] %} <!-- Show top 5 -->
                                            <li>{{ indicator.indicator }}: {{ indicator.description }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-gray-500">No key indicators identified.</p>
                                {% endif %}
                            </div>
                            <div class="space-y-4">
                                <h3 class="text-xl font-semibold text-gray-900">Potential Use Cases</h3>
                                {% if eda_summary.use_cases %}
                                    <ul class="list-disc pl-5 space-y-1 text-gray-700">
                                        {% for use_case in eda_summary.use_cases[:3] %} <!-- Show top 3 -->
                                            <li>{{ use_case.use_case }}: {{ use_case.description }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-gray-500">No specific use cases suggested.</p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mt-6 space-y-4">
                            <h3 class="text-xl font-semibold text-gray-900">Patterns & Relationships</h3>
                            {% if eda_summary.patterns_and_relationships %}
                                {% if eda_summary.patterns_and_relationships.correlations %}
                                    <div>
                                        <h4 class="font-medium text-gray-800">Correlations:</h4>
                                        <ul class="list-disc pl-5 text-gray-700">
                                            {% for corr in eda_summary.patterns_and_relationships.correlations[:3] %}
                                                <li>{{ corr.variable1 }} â†” {{ corr.variable2 }} ({{ "%.3f"|format(corr.correlation) }})</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                                {% if eda_summary.patterns_and_relationships.trends %}
                                    <div>
                                        <h4 class="font-medium text-gray-800">Trends:</h4>
                                        <ul class="list-disc pl-5 text-gray-700">
                                            {% for trend in eda_summary.patterns_and_relationships.trends[:3] %}
                                                <li>{{ trend.datetime_column }} vs {{ trend.numeric_column }} ({{ trend.trend_type }})</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                                {% if eda_summary.patterns_and_relationships.outliers %}
                                    <div>
                                        <h4 class="font-medium text-gray-800">Outliers:</h4>
                                        <ul class="list-disc pl-5 text-gray-700">
                                            {% for outlier in eda_summary.patterns_and_relationships.outliers[:3] %}
                                                <li>{{ outlier.column }} ({{ outlier.outlier_count }} outliers)</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                                {% if eda_summary.patterns_and_relationships.anomalies %}
                                    <div>
                                        <h4 class="font-medium text-gray-800">Anomalies:</h4>
                                        <ul class="list-disc pl-5 text-gray-700">
                                            {% for anomaly in eda_summary.patterns_and_relationships.anomalies[:3] %}
                                                <li>{{ anomaly.column }} ({{ anomaly.anomaly_type }})</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            {% else %}
                                <p class="text-gray-500">No patterns detected.</p>
                            {% endif %}
                        </div>

                        <div class="mt-6 space-y-4">
                            <h3 class="text-xl font-semibold text-gray-900">Recommendations</h3>
                            {% if eda_summary.recommendations %}
                                <ul class="list-disc pl-5 space-y-1 text-gray-700">
                                    {% for rec in eda_summary.recommendations %}
                                        <li>{{ rec.title }}: {{ rec.description }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-gray-500">No specific recommendations provided.</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-gray-500">No EDA summary available for this dataset.</p>
                    {% endif %}
                </div>
            </section>

            <!-- Visual Gallery Section -->
            <section id="visualizations-section" class="analysis-section hidden">
                <div class="light-card rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-gray-900">Advanced Visuals</h2>
                        <span class="badge badge-soft">EDA-driven</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% if eda_summary and eda_summary.patterns_and_relationships %}
                            {% if eda_summary.patterns_and_relationships.correlations %}
                                <div class="light-card rounded-2xl p-4 flex flex-col">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-semibold text-gray-900">Correlation Heatmap</h4>
                                        <span class="badge badge-soft">Correlation</span>
                                    </div>
                                    <div class="chart-container flex-grow h-80" id="correlation-heatmap"></div>
                                </div>
                            {% endif %}
                            {% if eda_summary.patterns_and_relationships.trends %}
                                <div class="light-card rounded-2xl p-4 flex flex-col">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-semibold text-gray-900">Trend Analysis</h4>
                                        <span class="badge badge-soft">Time Series</span>
                                    </div>
                                    <div class="chart-container flex-grow h-80" id="trends-chart"></div>
                                </div>
                            {% endif %}
                            {% if eda_summary.patterns_and_relationships.outliers %}
                                <div class="light-card rounded-2xl p-4 flex flex-col">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-semibold text-gray-900">Outlier Visualization</h4>
                                        <span class="badge badge-soft">Anomaly</span>
                                    </div>
                                    <div class="chart-container flex-grow h-80" id="outliers-chart"></div>
                                </div>
                            {% endif %}
                            {% if eda_summary.use_cases %}
                                <div class="light-card rounded-2xl p-4 flex flex-col">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-semibold text-gray-900">Use Cases Overview</h4>
                                        <span class="badge badge-soft">Product</span>
                                    </div>
                                    <div class="chart-container flex-grow h-80" id="use-cases-chart"></div>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-warning light-card bg-amber-50 text-amber-700 border border-amber-200">
                                <div class="flex-1 text-amber-700">
                                    Advanced visualizations not available for this dataset.
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- Column Profiling Section -->
            <section id="column_profiling-section" class="analysis-section hidden">
                <div class="light-card rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-gray-900">Column Profiling</h2>
                        <span class="badge badge-soft">Schema</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra text-sm w-full">
                            <thead class="text-gray-500 bg-gray-50">
                                <tr>
                                    <th>Column Name</th>
                                    <th>Data Type</th>
                                    <th>Missing Values</th>
                                    <th>Unique Values</th>
                                    <th>Role</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Mean</th>
                                    <th>Top Categories</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                {% for col in dataset_profile.columns %}
                                    <tr>
                                        <td class="font-medium">{{ col.name }}</td>
                                        <td>{{ col.dtype }}</td>
                                        <td>{{ col.missing_count }}</td>
                                        <td>{{ col.unique_count }}</td>
                                        <td>
                                            <span class="badge badge-xs badge-soft text-xs">{{ col.role }}</span>
                                        </td>
                                        <td>{{ col.stats.min if col.stats and col.stats.get('min') is not none else 'N/A' }}</td>
                                        <td>{{ col.stats.max if col.stats and col.stats.get('max') is not none else 'N/A' }}</td>
                                        <td>{{ "%.2f"|format(col.stats.mean) if col.stats and col.stats.get('mean') is not none else 'N/A' }}</td>
                                        <td>
                                            {% if col.top_categories %}
                                                {% for cat in col.top_categories[:3] %}
                                                    <span class="badge badge-xs badge-soft mr-1">{{ cat.value|truncate(10, True) }} ({{ cat.count }})</span>
                                                {% endfor %}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Pass data from backend to frontend JS
        window.CATEGORY_CHARTS = {{ category_charts | tojson }};
        window.ALL_CHARTS = {{ all_charts | tojson }};
        window.EDA_SUMMARY = {{ eda_summary | tojson }};
        window.PRIMARY_CHART = {{ primary_chart | tojson }};
        window.PRIMARY_CHART_COLUMN = window.PRIMARY_CHART ? window.PRIMARY_CHART.column : null;
    </script>
    <script src="/static/js/dashboard.js"></script>
</body>
</html>