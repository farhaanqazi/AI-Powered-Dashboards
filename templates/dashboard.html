<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            background: radial-gradient(circle at 20% 20%, rgba(147, 197, 253, 0.05), transparent 25%),
                        radial-gradient(circle at 80% 0%, rgba(167, 139, 250, 0.05), transparent 30%),
                        radial-gradient(circle at 40% 80%, rgba(74, 222, 128, 0.03), transparent 30%),
                        #f9fafb; /* Light background */
            color: #1f2937; /* Dark text */
        }
        .light-card {
            background-color: #ffffff; /* White background */
            border: 1px solid #e5e7eb; /* Light border */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* Subtle shadow */
        }
        .badge-soft {
            background-color: #e5e7eb; /* Light gray badge */
            color: #4b5563; /* Darker gray text */
        }
        .tab {
            color: #6b7280; /* Lighter text for inactive tab */
            border-bottom: 2px solid transparent;
        }
        .tab-active {
            color: #1f2937; /* Darker text for active tab */
            border-bottom: 2px solid #3b82f6; /* Blue indicator */
        }
        .chart-container {
            min-height: 300px; /* Ensure chart containers have height */
        }
        .kpi-badge {
            transition: background-color 0.2s, color 0.2s;
        }
        .kpi-badge:hover {
            background-color: #dbeafe; /* Light blue on hover */
            color: #1d4ed8; /* Darker blue text on hover */
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-3">
                <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-blue-500 via-purple-500 to-emerald-400 grid place-items-center text-white font-bold">AI</div>
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-gray-500">Dashboard Generator</p>
                    <h1 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        Dataset Insights
                        {% if original_filename %}
                            {% set name_parts = original_filename.split('.') %}
                            {% set name_without_ext = name_parts[0] if name_parts|length > 0 else original_filename %}
                            {% set formatted_name = name_without_ext|replace('_', ' ')|replace('-', ' ')|title %}
                            <span class="text-sm font-normal text-gray-500">- {{ formatted_name }}</span>
                        {% endif %}
                    </h1>
                </div>
            </div>
            <div>
                <button class="btn btn-sm btn-outline text-gray-700 border-gray-300">Export</button>
            </div>
        </header>

        <div class="mb-6">
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <!-- Smaller, side-by-side stats cards -->
                <div class="flex gap-2">
                    <div class="light-card rounded-xl p-3 min-w-[100px] text-center">
                        <p class="text-xs text-gray-500">Rows</p>
                        <p class="text-xl font-semibold text-gray-900">{{ dataset_profile.n_rows }}</p>
                    </div>
                    <div class="light-card rounded-xl p-3 min-w-[100px] text-center">
                        <p class="text-xs text-gray-500">Columns</p>
                        <p class="text-xl font-semibold text-gray-900">{{ dataset_profile.n_cols }}</p>
                    </div>
                    {% if dataset_profile.role_counts %}
                        <div class="light-card rounded-xl p-3 min-w-[100px] text-center">
                            <p class="text-xs text-gray-500">Numeric</p>
                            <p class="text-xl font-semibold text-gray-900">{{ dataset_profile.role_counts.numeric }}</p>
                        </div>
                        <div class="light-card rounded-xl p-3 min-w-[100px] text-center">
                            <p class="text-xs text-gray-500">Categorical</p>
                            <p class="text-xl font-semibold text-gray-900">{{ dataset_profile.role_counts.categorical }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Visible Tabs -->
            <div class="tabs tabs-boxed bg-gray-100 mb-6">
                <button class="tab tab-active" onclick="showSection('overview', event)">Overview</button>
                <button class="tab" onclick="showSection('eda', event)">EDA Insights</button>
                <button class="tab" onclick="showSection('visualizations', event)">Visual Gallery</button>
                <button class="tab" onclick="showSection('column_profiling', event)">Columns</button>
            </div>
        </div>

        <div class="space-y-6">
            <!-- Overview Section -->
            <section id="overview-section" class="analysis-section">
                <div class="light-card rounded-3xl p-6 mb-6">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div>
                            <p class="text-xs uppercase tracking-[0.25em] text-gray-500 mb-2">KPIs</p>
                            <div class="flex flex-wrap gap-2">
                                {% if kpis and kpis|length > 0 %}
                                    {% for kpi in kpis %}
                                        <div class="badge badge-soft kpi-badge text-gray-700 bg-gray-100 border border-gray-200"
                                             data-kpi-column="{{ kpi.label }}"
                                             data-has-chart="{% if kpi.label in category_charts %}1{% else %}0{% endif %}">
                                            <span class="font-semibold">{{ kpi.label|title }}:</span> {{ kpi.value }}
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-gray-500 text-sm">No KPIs generated.</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-right text-sm text-gray-600">
                            <p class="font-semibold text-gray-900">Quick summary</p>
                            <p>We prioritized key distributions and metrics to provide clear insights.</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    {% if primary_chart %}
                        <div class="lg:col-span-2 light-card rounded-3xl p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-semibold text-gray-900">{{ primary_chart.title or primary_chart.column|title }}</h3>
                                <span class="badge badge-soft">Featured</span>
                            </div>
                            <div class="chart-container h-80" id="primary-chart"></div>
                        </div>
                    {% endif %}

                    <div class="lg:col-span-1 space-y-4">
                        {% if category_charts %}
                            {% for column, chart_data in category_charts.items() %}
                                <div class="light-card rounded-2xl p-4">
                                    <h4 class="text-md font-semibold text-gray-900 mb-2">{{ chart_data.title or column|title }}</h4>
                                    <div class="chart-container h-48" id="chart-{{ column|replace(' ', '_')|replace('.', '_') }}"></div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="light-card rounded-2xl p-4 text-center text-gray-500 italic">
                                No categorical charts generated.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="light-card rounded-3xl p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-gray-900">All Generated Charts</h2>
                        <span class="badge badge-soft">Gallery</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        {% if all_charts %}
                            {% for chart in all_charts %}
                                <div class="light-card rounded-2xl p-4">
                                    <h4 class="text-md font-semibold text-gray-900 mb-2">{{ chart.title or chart.id|title }}</h4>
                                    <div class="chart-container h-64" id="chart-{{ chart.id }}"></div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-span-full light-card rounded-2xl p-4 text-center text-gray-500 italic">
                                No additional charts generated.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- EDA Insights Section -->
            <section id="eda-section" class="analysis-section hidden">
                <div class="light-card rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-gray-900">EDA Insights</h2>
                        <span class="badge badge-soft">Analysis</span>
                    </div>
                    {% if eda_summary %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h3 class="text-xl font-semibold text-gray-900">Key Indicators</h3>
                                {% if eda_summary.key_indicators %}
                                    <ul class="list-disc pl-5 space-y-1 text-gray-700">
                                        {% for indicator in eda_summary.key_indicators[:5] %} <!-- Show top 5 -->
                                            <li>{{ indicator.indicator }}: {{ indicator.description }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-gray-500">No key indicators identified.</p>
                                {% endif %}
                            </div>
                            <div class="space-y-4">
                                <h3 class="text-xl font-semibold text-gray-900">Potential Use Cases</h3>
                                {% if eda_summary.use_cases %}
                                    <ul class="list-disc pl-5 space-y-1 text-gray-700">
                                        {% for use_case in eda_summary.use_cases[:3] %} <!-- Show top 3 -->
                                            <li>{{ use_case.use_case }}: {{ use_case.description }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-gray-500">No specific use cases suggested.</p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mt-6 space-y-4">
                            <h3 class="text-xl font-semibold text-gray-900">Patterns & Relationships</h3>
                            {% if eda_summary.patterns_and_relationships %}
                                {% if eda_summary.patterns_and_relationships.correlations %}
                                    <div>
                                        <h4 class="font-medium text-gray-800">Correlations:</h4>
                                        <ul class="list-disc pl-5 text-gray-700">
                                            {% for corr in eda_summary.patterns_and_relationships.correlations[:3] %}
                                                <li>{{ corr.variable1 }} ↔ {{ corr.variable2 }} ({{ "%.3f"|format(corr.correlation) }})</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                                {% if eda_summary.patterns_and_relationships.trends %}
                                    <div>
                                        <h4 class="font-medium text-gray-800">Trends:</h4>
                                        <ul class="list-disc pl-5 text-gray-700">
                                            {% for trend in eda_summary.patterns_and_relationships.trends[:3] %}
                                                <li>{{ trend.datetime_column }} vs {{ trend.numeric_column }} ({{ trend.trend_type }})</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                                {% if eda_summary.patterns_and_relationships.outliers %}
                                    <div>
                                        <h4 class="font-medium text-gray-800">Outliers:</h4>
                                        <ul class="list-disc pl-5 text-gray-700">
                                            {% for outlier in eda_summary.patterns_and_relationships.outliers[:3] %}
                                                <li>{{ outlier.column }} ({{ outlier.outlier_count }} outliers)</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                                {% if eda_summary.patterns_and_relationships.anomalies %}
                                    <div>
                                        <h4 class="font-medium text-gray-800">Anomalies:</h4>
                                        <ul class="list-disc pl-5 text-gray-700">
                                            {% for anomaly in eda_summary.patterns_and_relationships.anomalies[:3] %}
                                                <li>{{ anomaly.column }} ({{ anomaly.anomaly_type }})</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            {% else %}
                                <p class="text-gray-500">No patterns detected.</p>
                            {% endif %}
                        </div>

                        <div class="mt-6 space-y-4">
                            <h3 class="text-xl font-semibold text-gray-900">Recommendations</h3>
                            {% if eda_summary.recommendations %}
                                <ul class="list-disc pl-5 space-y-1 text-gray-700">
                                    {% for rec in eda_summary.recommendations %}
                                        <li>{{ rec.title }}: {{ rec.description }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-gray-500">No specific recommendations provided.</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-gray-500">No EDA summary available for this dataset.</p>
                    {% endif %}
                </div>
            </section>

            <!-- Visual Gallery Section -->
            <section id="visualizations-section" class="analysis-section hidden">
                <div class="light-card rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-gray-900">Advanced Visuals</h2>
                        <span class="badge badge-soft">EDA-driven</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% if eda_summary and eda_summary.patterns_and_relationships %}
                            {% if eda_summary.patterns_and_relationships.correlations %}
                                <div class="light-card rounded-2xl p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-semibold text-gray-900">Correlation Heatmap</h4>
                                        <span class="badge badge-soft">Correlation</span>
                                    </div>
                                    <div class="chart-container h-80" id="correlation-heatmap"></div>
                                </div>
                            {% endif %}
                            {% if eda_summary.patterns_and_relationships.trends %}
                                <div class="light-card rounded-2xl p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-semibold text-gray-900">Trend Analysis</h4>
                                        <span class="badge badge-soft">Time Series</span>
                                    </div>
                                    <div class="chart-container h-80" id="trends-chart"></div>
                                </div>
                            {% endif %}
                            {% if eda_summary.patterns_and_relationships.outliers %}
                                <div class="light-card rounded-2xl p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-semibold text-gray-900">Outlier Visualization</h4>
                                        <span class="badge badge-soft">Anomaly</span>
                                    </div>
                                    <div class="chart-container h-80" id="outliers-chart"></div>
                                </div>
                            {% endif %}
                            {% if eda_summary.use_cases %}
                                <div class="light-card rounded-2xl p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-semibold text-gray-900">Use Cases Overview</h4>
                                        <span class="badge badge-soft">Product</span>
                                    </div>
                                    <div class="chart-container h-80" id="use-cases-chart"></div>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-warning light-card bg-amber-50 text-amber-700 border border-amber-200">
                                <div class="flex-1 text-amber-700">
                                    Advanced visualizations not available for this dataset.
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- Column Profiling Section -->
            <section id="column_profiling-section" class="analysis-section hidden">
                <div class="light-card rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold text-gray-900">Column Profiling</h2>
                        <span class="badge badge-soft">Schema</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra text-sm w-full">
                            <thead class="text-gray-500 bg-gray-50">
                                <tr>
                                    <th>Column Name</th>
                                    <th>Data Type</th>
                                    <th>Missing Values</th>
                                    <th>Unique Values</th>
                                    <th>Role</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Mean</th>
                                    <th>Top Categories</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                {% for col in dataset_profile.columns %}
                                    <tr>
                                        <td class="font-medium">{{ col.name }}</td>
                                        <td>{{ col.dtype }}</td>
                                        <td>{{ col.missing_count }}</td>
                                        <td>{{ col.unique_count }}</td>
                                        <td>
                                            <span class="badge badge-xs badge-soft text-xs">{{ col.role }}</span>
                                        </td>
                                        <td>{{ col.stats.min if col.stats and col.stats.min is not none else 'N/A' }}</td>
                                        <td>{{ col.stats.max if col.stats and col.stats.max is not none else 'N/A' }}</td>
                                        <td>{{ "%.2f"|format(col.stats.mean) if col.stats and col.stats.mean is not none else 'N/A' }}</td>
                                        <td>
                                            {% if col.top_categories %}
                                                {% for cat in col.top_categories[:3] %}
                                                    <span class="badge badge-xs badge-soft mr-1">{{ cat.value|truncate(10, True) }} ({{ cat.count }})</span>
                                                {% endfor %}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Pass data from backend to frontend JS
        const CATEGORY_CHARTS = {{ category_charts | tojson }};
        const ALL_CHARTS = {{ all_charts | tojson }};
        const EDA_SUMMARY = {{ eda_summary | tojson }};
        const PRIMARY_CHART = {{ primary_chart | tojson }};
        const PRIMARY_CHART_COLUMN = PRIMARY_CHART ? PRIMARY_CHART.column : null;

        function showSection(sectionName, evt) {
            // Hide all sections
            document.querySelectorAll('.analysis-section').forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('tab-active');
            });

            // Show selected section
            const sectionElement = document.getElementById(sectionName + '-section');
            if (sectionElement) {
                sectionElement.classList.remove('hidden');
                sectionElement.classList.add('active');
            }

            // Add active class to clicked tab
            const trigger = evt ? evt.currentTarget : null;
            if (trigger) {
                trigger.classList.add('tab-active');
            }

            // If switching to visualizations section, render the charts
            if (sectionName === 'visualizations' && EDA_SUMMARY) {
                setTimeout(renderAdvancedVisualizations, 100); // Delay to ensure DOM is ready
            }
        }

        function loadChartForColumn(columnName) {
            const chart = CATEGORY_CHARTS[columnName];
            if (!chart) {
                // No precomputed chart for this column – silently ignore
                return;
            }

            // Find the corresponding chart container and scroll to it
            const containerId = "chart-" + columnName.replace(/[\s.]/g, '_');
            const chartContainer = document.getElementById(containerId);
            if (chartContainer) {
                chartContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Add temporary highlight
                chartContainer.style.border = '3px solid #3b82f6'; // Tailwind blue-500
                setTimeout(() => {
                    chartContainer.style.border = '';
                }, 3000);
            }
        }

        // Function to render advanced visualizations based on EDA summary
        function renderAdvancedVisualizations() {
            if (!EDA_SUMMARY) {
                console.warn("No EDA summary available for visualization");
                return;
            }

            // Render correlation heatmap if correlations exist
            if (EDA_SUMMARY.patterns_and_relationships && EDA_SUMMARY.patterns_and_relationships.correlations) {
                renderCorrelationHeatmap();
            }

            // Render key indicators bar chart if key indicators exist
            if (EDA_SUMMARY.key_indicators && EDA_SUMMARY.key_indicators.length > 0) {
                renderKeyIndicatorsChart();
            }

            // Render trends chart if trends exist
            if (EDA_SUMMARY.patterns_and_relationships && EDA_SUMMARY.patterns_and_relationships.trends) {
                renderTrendsChart();
            }

            // Render outliers chart if outliers exist
            if (EDA_SUMMARY.patterns_and_relationships && EDA_SUMMARY.patterns_and_relationships.outliers) {
                renderOutliersChart();
            }

            // Render use cases chart if use cases exist
            if (EDA_SUMMARY.use_cases && EDA_SUMMARY.use_cases.length > 0) {
                renderUseCasesChart();
            }
        }

        // Render correlation heatmap
        function renderCorrelationHeatmap() {
            const correlations = EDA_SUMMARY.patterns_and_relationships.correlations;
            if (!correlations || correlations.length === 0) return;

            // Extract unique variables
            const variables = new Set();
            correlations.forEach(corr => {
                variables.add(corr.variable1);
                variables.add(corr.variable2);
            });
            const varList = Array.from(variables);
            const n = varList.length;

            // Create correlation matrix
            const matrix = Array(n).fill().map(() => Array(n).fill(0));
            const varMap = {};
            varList.forEach((v, i) => { varMap[v] = i; });

            correlations.forEach(corr => {
                const i = varMap[corr.variable1];
                const j = varMap[corr.variable2];
                if (i !== undefined && j !== undefined) {
                    matrix[i][j] = corr.correlation;
                    matrix[j][i] = corr.correlation; // Assuming symmetric for display
                }
            });

            const trace = {
                type: 'heatmap',
                x: varList,
                y: varList,
                z: matrix,
                colorscale: 'RdBu',
                zmid: 0,
                text: matrix.map(row => row.map(val => val.toFixed(2))),
                texttemplate: "%{text}",
                textfont: { size: 12 },
                colorbar: { title: "Correlation" }
            };

            const layout = {
                title: "Correlation Heatmap",
                xaxis: { title: "Variables", automargin: true },
                yaxis: { title: "Variables", automargin: true },
                margin: { t: 40, l: 100, r: 40, b: 100 }
            };

            Plotly.react('correlation-heatmap', [trace], layout);
        }

        // Render key indicators chart (simple bar chart)
        function renderKeyIndicatorsChart() {
            const indicators = EDA_SUMMARY.key_indicators.slice(0, 10); // Top 10
            if (!indicators || indicators.length === 0) return;

            const labels = indicators.map(ind => ind.indicator);
            const values = indicators.map(ind => ind.significance_score);

            const trace = {
                x: values,
                y: labels,
                type: 'bar',
                orientation: 'h',
                marker: { color: '#3b82f6' } // Tailwind blue-500
            };

            const layout = {
                title: "Top Key Indicators by Significance Score",
                xaxis: { title: "Significance Score", automargin: true },
                yaxis: { title: "Indicator", automargin: true, tickangle: -45 },
                height: 600,
                margin: { t: 40, l: 150, r: 40, b: 100 }
            };

            Plotly.react('trends-chart', [trace], layout); // Reusing trends div for simplicity, could use dedicated ID
        }

        // Render trends chart (simple bar chart for count of trend types)
        function renderTrendsChart() {
            const trends = EDA_SUMMARY.patterns_and_relationships.trends;
            if (!trends || trends.length === 0) return;

            const typeCounts = {};
            trends.forEach(t => {
                typeCounts[t.trend_type] = (typeCounts[t.trend_type] || 0) + 1;
            });

            const labels = Object.keys(typeCounts);
            const values = Object.values(typeCounts);

            const trace = {
                x: labels,
                y: values,
                type: 'bar',
                marker: { color: '#10b981' } // Tailwind emerald-500
            };

            const layout = {
                title: "Distribution of Time Series Trends",
                xaxis: { title: "Trend Type", automargin: true },
                yaxis: { title: "Count", automargin: true },
                height: 400,
                margin: { t: 40, l: 60, r: 40, b: 80 }
            };

            Plotly.react('trends-chart', [trace], layout);
        }

        // Render outliers chart (simple bar chart for outlier counts)
        function renderOutliersChart() {
            const outliers = EDA_SUMMARY.patterns_and_relationships.outliers;
            if (!outliers || outliers.length === 0) return;

            const labels = outliers.map(o => o.column);
            const values = outliers.map(o => o.outlier_count);

            const trace = {
                x: labels,
                y: values,
                type: 'bar',
                marker: { color: '#ef4444' } // Tailwind red-500
            };

            const layout = {
                title: "Outlier Count by Column",
                xaxis: { title: "Column", automargin: true, tickangle: 45 },
                yaxis: { title: "Outlier Count", automargin: true },
                height: 400,
                margin: { t: 40, l: 60, r: 40, b: 120 }
            };

            Plotly.react('outliers-chart', [trace], layout);
        }

        // Render use cases chart (simple bar chart for key inputs count)
        function renderUseCasesChart() {
            const useCases = EDA_SUMMARY.use_cases;
            if (!useCases || useCases.length === 0) return;

            const labels = useCases.map(uc => uc.use_case.substring(0, 20) + (uc.use_case.length > 20 ? '...' : '')); // Truncate for display
            const values = useCases.map(uc => uc.key_inputs.length);

            const trace = {
                x: labels,
                y: values,
                type: 'bar',
                marker: { color: '#8b5cf6' } // Tailwind violet-500
            };

            const layout = {
                title: "Number of Key Inputs per Use Case",
                xaxis: { title: "Use Case", automargin: true, tickangle: 45 },
                yaxis: { title: "Number of Key Inputs", automargin: true },
                height: 400,
                margin: { t: 40, l: 60, r: 40, b: 120 }
            };

            Plotly.react('use-cases-chart', [trace], layout);
        }


        // --- Simple Renderer Logic (Adapted for Light Theme Colors) ---
        function renderEmptyChart(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500 italic">${message}</div>`;
            }
        }

        // Function to render simple bar charts from the new renderer
        function _renderSimpleBarChart(chartData, containerId) {
            if (!chartData.data || chartData.data.length === 0) {
                renderEmptyChart(containerId, "No data available");
                return;
            }

            // Filter valid data points with x and y values
            const validData = chartData.data.filter(d => d.x !== undefined && d.y !== undefined && d.x !== null && d.y !== null);
            if (validData.length === 0) {
                 renderEmptyChart(containerId, "No valid data points");
                 return;
            }

            const categories = validData.map(d => d.x.toString());
            const values = validData.map(d => parseFloat(d.y)); // Ensure numeric

            if (categories.length === 0 || values.length === 0) {
                 renderEmptyChart(containerId, "No categories or values");
                 return;
            }

            // Check for non-numeric values after parsing
            if (values.some(v => isNaN(v))) {
                 renderEmptyChart(containerId, "Non-numeric values found");
                 return;
            }

            const maxVal = Math.max(...values, 0);
            const avgLabelLen = categories.reduce((sum, c) => sum + c.length, 0) / categories.length;
            const manyCategories = categories.length > 6;
            const longLabels = avgLabelLen > 12;
            const useHorizontal = manyCategories || longLabels;
            const title = chartData.title || `Chart for ${chartData.column || ""}`;

            let trace, layout;
            if (useHorizontal) {
                trace = {
                    type: "bar",
                    x: values,
                    y: categories,
                    orientation: "h",
                    text: values,
                    textposition: "outside",
                    marker: { color: '#3b82f6' } // Light theme blue
                };
                layout = {
                    xaxis: {
                        title: "Value",
                        tickformat: ",d",
                        exponentformat: "none",
                        rangemode: "tozero",
                        range: [0, maxVal * 1.15 || 1],
                        automargin: true
                    },
                    yaxis: {
                        title: chartData.column || "Category",
                        categoryorder: "array",
                        categoryarray: categories,
                        automargin: true
                    },
                    margin: {
                        t: 20,
                        b: 60,
                        l: 100, // Increased left margin for longer y-axis labels
                        r: 20
                    },
                    height: 320,
                    title: { text: title, x: 0.05 } // Add title inside plot area
                };
            } else {
                trace = {
                    type: "bar",
                    x: categories,
                    y: values,
                    text: values,
                    textposition: "outside",
                    marker: { color: '#3b82f6' } // Light theme blue
                };
                layout = {
                    xaxis: {
                        title: chartData.column || "Category",
                        categoryorder: "array",
                        categoryarray: categories,
                        automargin: true,
                        tickangle: 45
                    },
                    yaxis: {
                        title: "Value",
                        tickformat: ",d",
                        exponentformat: "none",
                        rangemode: "tozero",
                        range: [0, maxVal * 1.15 || 1],
                        automargin: true
                    },
                    margin: {
                        t: 40, // Increased top margin for title
                        b: 100, // Increased bottom margin for x-axis labels
                        l: 60,
                        r: 20
                    },
                    height: 320,
                     title: { text: title, x: 0.05 } // Add title inside plot area
                };
            }

            Plotly.react(containerId, [trace], layout);
        }


        document.addEventListener("DOMContentLoaded", function () {
            try {
                // Render primary chart if it exists
                if (PRIMARY_CHART) {
                     _renderSimpleBarChart(PRIMARY_CHART, 'primary-chart');
                }

                // Render all category charts
                if (typeof CATEGORY_CHARTS === 'object' && CATEGORY_CHARTS !== null) {
                    Object.keys(CATEGORY_CHARTS).forEach(function(columnName) {
                        try {
                            const chartData = CATEGORY_CHARTS[columnName];
                            const containerId = "chart-" + columnName.replace(/[\s.]/g, '_');
                            _renderSimpleBarChart(chartData, containerId);
                        } catch (e) {
                            console.error("Error rendering category chart for " + columnName + ":", e);
                        }
                    });
                }

                // Render all other charts
                 if (typeof ALL_CHARTS === 'object' && ALL_CHARTS !== null) {
                    ALL_CHARTS.forEach(function(chartSpec) {
                        try {
                            const containerId = "chart-" + chartSpec.id;
                            // Determine chart type and render accordingly
                            // For simplicity, defaulting to bar chart logic here, adjust as needed based on chartSpec.type
                            _renderSimpleBarChart(chartSpec, containerId);
                        } catch (e) {
                            console.error("Error rendering chart " + chartSpec.id + ":", e);
                        }
                    });
                }


                // Add click listeners to KPI badges
                const kpiItems = document.querySelectorAll("[data-kpi-column]");
                kpiItems.forEach(item => {
                    item.addEventListener("click", function () {
                        try {
                            const hasChart = this.getAttribute("data-has-chart") === "1";
                            if (!hasChart) {
                                // No chart wired to this KPI; do nothing visibly.
                                // Optional: console.log for debugging
                                // console.log("No chart for KPI:", this.getAttribute("data-kpi-column"));
                                return;
                            }
                            const col = this.getAttribute("data-kpi-column");
                            if (col) {
                                loadChartForColumn(col);
                            }
                        } catch (error) {
                            console.error("Error in KPI click handler:", error);
                        }
                    });
                });
            } catch (error) {
                console.error("Error in DOMContentLoaded:", error);
            }
        });
    </script>
</body>
</html>